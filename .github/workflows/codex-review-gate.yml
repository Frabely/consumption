name: Codex Review Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]

jobs:
  codex-review-gate:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Validate PR review gate checklist and content quality
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const failures = [];

            const sectionExists = (title) =>
              new RegExp(`^##\\s+${title}\\s*$`, "im").test(body);

            const extractSection = (title) => {
              const regex = new RegExp(
                `##\\s+${title}\\s*([\\s\\S]*?)(?=\\n##\\s+|$)`,
                "i",
              );
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            };

            const requiredSections = [
              "Summary",
              "User Impact",
              "Risks and Rollback",
              "Test Evidence",
              "Codex Review Findings",
              "Codex Review Gate",
            ];

            for (const section of requiredSections) {
              if (!sectionExists(section)) {
                failures.push(`Missing required section: '${section}'.`);
              }
            }

            const summary = extractSection("Summary");
            if (!summary || /Describe what changed and why\./i.test(summary)) {
              failures.push("Summary is missing or still uses placeholder text.");
            }

            const userImpact = extractSection("User Impact");
            if (!userImpact || /What does a user or PO notice/i.test(userImpact)) {
              failures.push("User Impact is missing or still uses placeholder text.");
            }

            const risks = extractSection("Risks and Rollback");
            if (!risks || /Main regression risks:/i.test(risks) && /Rollback strategy:/i.test(risks)) {
              failures.push("Risks and Rollback is missing concrete content.");
            }

            const testEvidence = extractSection("Test Evidence");
            const checkedEvidenceItems = [...testEvidence.matchAll(/-\s+\[x\]\s+/gi)].length;
            if (checkedEvidenceItems === 0) {
              failures.push("Test Evidence has no checked item.");
            }

            const findings = extractSection("Codex Review Findings");
            const p0Match = findings.match(/-\s*P0\s*:\s*(.*)/i);
            const p1Match = findings.match(/-\s*P1\s*:\s*(.*)/i);
            if (!p0Match || !p0Match[1].trim()) {
              failures.push("Codex Review Findings: P0 line is missing or empty.");
            }
            if (!p1Match || !p1Match[1].trim()) {
              failures.push("Codex Review Findings: P1 line is missing or empty.");
            }

            const nonePattern = /^(none|keine|n\/a|0|no findings)$/i;
            const p0Value = p0Match ? p0Match[1].trim() : "";
            const p1Value = p1Match ? p1Match[1].trim() : "";
            const p0OrP1MarkedNone = nonePattern.test(p0Value) || nonePattern.test(p1Value);
            if (!p0OrP1MarkedNone) {
              const gateSection = extractSection("Codex Review Gate");
              if (/\[x\]\s+Confirmed no open P0\/P1 findings remain/i.test(gateSection)) {
                failures.push("Gate contradiction: P0/P1 are not marked as none, but gate says no open P0/P1 remain.");
              }
            }

            const requiredGateChecks = [
              /\[x\]\s+Confirmed no open P0\/P1 findings remain/i,
              /\[x\]\s+UI\/UX states checked \(loading, empty, error, disabled, focus, mobile\)/i,
              /\[x\]\s+User impact and rollback risk documented/i,
              /\[x\]\s+Tests mapped to changed behavior \(unit\/integration\/e2e or manual reason\)/i,
            ];

            const gateSection = extractSection("Codex Review Gate");
            requiredGateChecks.forEach((pattern, index) => {
              if (!pattern.test(gateSection)) {
                failures.push(`Codex Review Gate checklist item ${index + 1} is not checked.`);
              }
            });

            if (failures.length > 0) {
              core.setFailed(
                "Codex Review Gate failed:\n- " + failures.join("\n- "),
              );
            }

